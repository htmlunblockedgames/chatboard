<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Poly Track Chatboard</title>
  <style>
    /* ===== Site Palette ===== */
    :root{
      --bg:#fafafa; --panel:#ffffff; --panel-2:#f5f5f5;
      --border:#dadce0; --border-2:#e0e0e0;
      --text:#1f2125; --muted:#5f6369;
      --accent:#2694d5; --accent-2:#0280ca;
      --ok:#0f9d58; --danger:#d93025;
      --radius:16px; --inner:18px;
      --shadow:0 8px 18px rgba(0,0,0,.05);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      font-weight:600; color:var(--text); background:var(--bg);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      letter-spacing:.1px;
    }

    /* Header */
    header{
      padding:18px 16px; border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between;
      background:linear-gradient(180deg,#ffffff,#fbfbfb);
    }
    header h1{margin:0;font-size:20px;font-weight:800}
    .status{
      font-size:12px; padding:6px 12px; border:1px solid var(--border);
      border-radius:999px; background:#fefefe; color:var(--muted);
    }
    .status.ok{color:#0b7d3b;border-color:#cfe8da;background:#f6fff9}
    .status.bad{color:#b3261e;border-color:#f1c9c6;background:#fff6f5}

    /* Layout */
    .container{max-width:920px;margin:0 auto;padding:20px;display:grid;gap:18px}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}

    /* Admin panel */
    #adminPanel{padding:18px;display:none;gap:10px}
    #adminPanel .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    #adminNote{font-size:12px;color:var(--muted)}
    .admin-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .tag{font-size:11px;border:1px solid var(--border-2);border-radius:999px;padding:3px 8px;color:var(--muted);background:#f9fafb}

    /* Composer */
    #composer{padding:18px;display:grid;gap:12px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row-slim{gap:8px}
    input[type="text"], textarea{
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--border);
      background:var(--panel-2); color:var(--text); outline:none;
      transition:border-color .15s, box-shadow .15s, background .2s;
      font-size:14px; font-weight:600;
    }
    input[type="text"]:focus, textarea:focus{
      border-color:var(--accent); box-shadow:0 0 0 3px #2694d522; background:#fff;
    }
    textarea{min-height:120px; resize:vertical; line-height:1.58}

    /* Buttons – unified size & font */
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:10px 14px; border-radius:12px; border:1px solid var(--border);
      background:#eaf5fc; color:#0f3c55; cursor:pointer;
      transition:transform .05s ease, background .15s, border-color .15s, color .15s;
      font-weight:700; font-size:14px; line-height:1; min-width:140px; height:40px;
      text-align:center; user-select:none;
    }
    .btn:hover{background:#dff0fb;border-color:#cfe8f8}
    .btn:active{transform:translateY(1px)}
    .btn.primary{
      background:linear-gradient(180deg,var(--accent),var(--accent-2));
      border-color:#197fb4; color:#fff;
    }
    .btn.primary:hover{filter:brightness(1.03)}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    /* Custom file input */
    #file{display:none}
    .file-btn{display:inline-flex}
    .file-name{font-size:12px;color:var(--muted)}

    /* Inline status */
    #status{display:none;font-size:12px;color:var(--muted)}

    /* Reply pill */
    #replyTo{
      display:none; font-size:12px; color:var(--muted);
      background:#f9f9f9; border:1px solid var(--border-2); padding:6px 10px;
      border-radius:999px;
    }
    #replyCancel{margin-left:8px;color:var(--accent);cursor:pointer;font-weight:800}

    /* Messages */
    #messages{padding:14px var(--inner);display:flex;flex-direction:column;gap:14px;min-height:36vh}
    .msg{
      display:flex; gap:12px; padding:12px 14px; border:1px solid var(--border);
      border-radius:14px; background:#fff;
    }
    .avatar{
      width:40px; height:40px; border-radius:50%;
      background:#b3c1fe22; display:flex; align-items:center; justify-content:center;
      font-weight:900; color:#1f2127; flex:0 0 40px; overflow:hidden; border:1px solid #b3c1fe66;
    }
    .avatar img{width:100%;height:100%;object-fit:cover}
    .bubble{flex:1;min-width:0}
    .meta{font-size:12px;color:var(--muted);display:flex;gap:10px;align-items:center}
    .nick{color:#1f2127;font-weight:800}
    .content{margin-top:6px;line-height:1.58;word-wrap:break-word}
    .content img{max-width:480px;border-radius:10px;border:1px solid var(--border);display:block;margin:8px 0;background:#fafafa}

    /* Actions */
    .actions{display:flex;gap:14px;align-items:center;margin-top:8px;flex-wrap:wrap}
    .action{
      font-size:12px;color:var(--accent);cursor:pointer;font-weight:800;
      background:#fdfdfd;border:1px solid var(--border-2);padding:6px 10px;border-radius:999px;
      user-select:none;
    }
    .action:hover{background:#f8f8f8}

    /* Replies container under each top-level */
    .replies{display:none; margin-top:10px; padding-left:0; display:flex; flex-direction:column; gap:10px}

    /* Load older – full bubble width */
    #loadMore{
      display:none; margin:8px var(--inner) 18px;
      width:calc(100% - var(--inner)*2);
    }

    .limits{font-size:12px;color:var(--muted)}
    a{color:var(--accent)}
  </style>
</head>
<body>
  <header>
    <h1>Poly Track Chatboard</h1>
    <div id="conn" class="status">Status: checking…</div>
  </header>

  <main class="container">
    <!-- Admin Panel (hidden; open via #admin or ?admin=1) -->
    <section id="adminPanel" class="panel">
      <div class="row">
        <strong>Admin</strong>
        <span id="adminNote" class="tag">Login to manage comments</span>
      </div>
      <div class="row" id="adminLoginRow">
        <input id="adminPass" type="password" placeholder="Admin password"/>
        <button id="btnAdminLogin" class="btn">Login</button>
      </div>
      <div class="row" id="adminControls" style="display:none">
        <span class="tag">Pinned: <span id="pinCount">0</span> / 3</span>
        <button id="btnAdminLogout" class="btn">Logout</button>
      </div>
    </section>

    <!-- Composer -->
    <section id="composer" class="panel">
      <div class="row">
        <input id="nick" type="text" placeholder="Nickname (optional, default Anonymous)"/>
      </div>

      <div id="replyTo" class="row">
        Replying to <strong id="replyName"></strong><span id="replyCancel" title="Cancel reply">✕</span>
      </div>

      <div class="row">
        <textarea id="text" placeholder="Type your message… You can also attach an image."></textarea>
      </div>

      <div class="row row-slim">
        <label for="file" class="btn file-btn" id="btnChoose">Choose image</label>
        <input id="file" type="file" accept="image/*"/>
        <span id="fileInfo" class="file-name"></span>
        <button id="btnAttach" class="btn">Attach image</button>
        <div style="margin-left:auto">
          <button id="btnSend" class="btn primary">Send</button>
        </div>
      </div>

      <div class="row row-slim" style="margin-top:-2px">
        <span class="limits">
          Images: PNG/JPG/GIF/WebP ≤ <span id="limitMb">5</span> MB · Message limit: <span id="limitChars">2000</span> chars ·
          <span id="charCount">0</span>/<span id="limitChars2">2000</span>
        </span>
        <span id="status" style="margin-left:auto"></span>
      </div>
    </section>

    <!-- Messages -->
    <section class="panel">
      <div id="messages"></div>
      <button id="loadMore" class="btn primary">Load older</button>
    </section>
  </main>

  <script>
  ;(() => {
    // ===== Configure if you move host/path =====
    const WORKER_URL    = "https://twikoo-cloudflare.ertertertet07.workers.dev";
    const PAGE_URL_PATH = "/chatboard/";
    const PAGE_HREF     = "https://htmlunblockedgames.github.io/chatboard/";
    const MAX_FILE_MB   = 5;
    const MAX_CHARS     = 2000;

    // DOM
    const $=id=>document.getElementById(id);
    const messagesEl=$("messages"), loadMoreBtn=$("loadMore");
    const nickEl=$("nick"), textEl=$("text");
    const fileEl=$("file"), btnAttach=$("btnAttach"), btnSend=$("btnSend"), btnChoose=$("btnChoose");
    const fileInfo=$("fileInfo"), statusEl=$("status"), connEl=$("conn");

    // Admin UI refs
    const adminPanel=$("adminPanel"), adminPass=$("adminPass"), btnAdminLogin=$("btnAdminLogin"),
          btnAdminLogout=$("btnAdminLogout"), adminLoginRow=$("adminLoginRow"),
          adminControls=$("adminControls"), pinCountEl=$("pinCount"), adminNote=$("adminNote");

    const limitMbEl=$("limitMb"), limitChars=$("limitChars"), limitChars2=$("limitChars2"), charCount=$("charCount");
    const replyTo=$("replyTo"), replyName=$("replyName"), replyCancel=$("replyCancel");

    // State
    let TK_TOKEN = localStorage.getItem('twikoo_access_token') || null;
    const state = { all:new Map(), tops:[] }; // id -> comment, plus tops[]
    let loading=false;
    let earliestMainCreated=null; // smallest created of current top-levels
    let replyTarget=null; // {_id, rid, nick}
    const expanded = new Set(); // top-level ids with visible replies
    let isAdmin = !!TK_TOKEN;

    // Limits text
    limitMbEl.textContent=MAX_FILE_MB;
    limitChars.textContent=MAX_CHARS;
    limitChars2.textContent=MAX_CHARS;

    // Helpers
    const initialOf = s => (s||"A").trim().charAt(0).toUpperCase();
    const setStatus=(t,isError=false)=>{
      if(!t){ statusEl.style.display="none"; statusEl.textContent=""; return; }
      statusEl.style.display="inline"; statusEl.textContent=t;
      statusEl.style.color = isError ? "var(--danger)" : "var(--muted)";
    };
    function fileToDataURL(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onerror=()=>rej(fr.error||new Error("FileReader error")); fr.onload=()=>res(fr.result); fr.readAsDataURL(file); }); }
    function insertAtCursor(el,text){ const s=el.selectionStart??el.value.length, e=el.selectionEnd??el.value.length; el.value=el.value.slice(0,s)+text+el.value.slice(e); const pos=s+text.length; el.setSelectionRange(pos,pos); el.focus(); }

    // Client-side nickname guard mirroring server rules
    function isForbiddenNick(nick){
      if (!nick) return false;
      const subs = { '0':'o','1':'i','!':'i','|':'i','l':'i','3':'e','4':'a','5':'s','7':'t','@':'a','$':'s' };
      let s = String(nick).toLowerCase();
      s = s.replace(/[0l1!|3457@$]/g, ch => subs[ch] || ch).replace(/[^a-z]/g,'');
      return s.includes('admin') || s.includes('administrator');
    }

    // API with token persistence
    async function api(eventObj){
      const body={...eventObj}; if (TK_TOKEN) body.accessToken=TK_TOKEN;
      const res=await fetch(WORKER_URL,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(body)});
      const json=await res.json().catch(()=>({}));
      if (json && json.accessToken){ TK_TOKEN=json.accessToken; localStorage.setItem('twikoo_access_token',TK_TOKEN); }
      return json;
    }

    // Admin helpers
    function revealAdminIfRequested(){
      const q = new URLSearchParams(location.search);
      if (q.get('admin') === '1' || location.hash === '#admin') {
        adminPanel.style.display = 'grid';
      }
    }
    function updateAdminUI(){
      if (!adminPanel) return;
      const pinned = state.tops.filter(x => Number(x.top) === 1).length;
      pinCountEl.textContent = String(pinned);
      if (isAdmin) {
        adminLoginRow.style.display = 'none';
        adminControls.style.display = 'flex';
        adminNote.textContent = 'You are logged in as admin';
      } else {
        adminLoginRow.style.display = 'flex';
        adminControls.style.display = 'none';
        adminNote.textContent = 'Login to manage comments';
      }
    }
    async function adminLogin(){
      const pw = adminPass.value.trim();
      if (!pw) { setStatus('Enter password', true); return; }
      const r = await api({event:'ADMIN_GET_TOKEN', password: pw});
      if (r && r.code === 0 && r.token) {
        TK_TOKEN = r.token;
        localStorage.setItem('twikoo_access_token', TK_TOKEN);
        isAdmin = true;
        await loadLatest();
        updateAdminUI();
        setStatus('Admin logged in');
      } else {
        setStatus(r?.message || 'Login failed', true);
      }
    }
    async function adminLogout(){
      if (TK_TOKEN) await api({event:'ADMIN_REVOKE_TOKEN', token: TK_TOKEN});
      isAdmin = false;
      TK_TOKEN = null;
      localStorage.removeItem('twikoo_access_token');
      updateAdminUI();
      setStatus('Logged out');
    }

    // Connection indicator
    async function checkConnection(){
      try{ await api({event:"GET_FUNC_VERSION"}); connEl.textContent="Status: Online"; connEl.classList.remove("bad"); connEl.classList.add("ok"); }
      catch{ connEl.textContent="Status: Offline"; connEl.classList.remove("ok"); connEl.classList.add("bad"); }
    }

    // ===== Flatten server payload and rebuild threads =====
    function mergeList(list){
      const temp = new Map();

      const pushItem = (src) => {
        const id = src._id || src.id; if (!id) return;
        temp.set(id, {
          ...src,
          _id: id,
          pid: src.pid || "",
          rid: src.rid || "",
          created: src.created || Date.now(),
          nick: src.nick || "Anonymous",
          avatar: src.avatar || "",
          comment: src.comment || "",
          depth: 0,
          parentNick: null,
          children: []
        });
      };

      (Array.isArray(list) ? list : []).forEach(top => {
        pushItem({ ...top, rid: "" });
        if (Array.isArray(top.replies)) {
          top.replies.forEach(r => pushItem(r));
        }
      });

      for (const obj of temp.values()){
        if ((obj.rid || "") === "") { obj.depth = 0; obj.parentNick = null; continue; }

        let depth = 1;
        let p = temp.get(obj.pid);
        const seen = new Set([obj._id]);
        while (p && (p.rid || "") !== "") {
          if (seen.has(p._id)) break;
          seen.add(p._id);
          depth++;
          p = temp.get(p.pid);
        }
        obj.depth = depth;
        obj.parentNick = (temp.get(obj.pid)?.nick) || obj.ruser || null;

        let root = obj;
        while (root && (root.rid || "") !== "") root = temp.get(root.pid);
        if (root) obj.rid = root._id;
      }

      for (const o of temp.values()) o.children = [];
      for (const o of temp.values()){
        if ((o.rid || "") !== ""){
          const root = temp.get(o.rid);
          if (root) root.children.push(o);
        }
      }
      for (const root of temp.values()){
        if (root.children && root.children.length){
          root.children.sort((a,b)=>(a.created||0)-(b.created||0));
        }
      }

      state.all = temp;
      state.tops = Array.from(temp.values()).filter(x => (x.rid || "") === "");
      state.tops.sort((a,b)=>(b.created||0)-(a.created||0));
      earliestMainCreated = state.tops.length ? Math.min(...state.tops.map(x=>x.created||Date.now())) : null;
    }

    function renderAll(){
      messagesEl.innerHTML="";
      const frag=document.createDocumentFragment();
      for (const c of state.tops){
        const node = renderMsg(c);

        // Admin controls for top-level
        if (isAdmin && (c.rid || '') === '') {
          const actions = node.querySelector('.actions');
          if (actions) {
            const pinBtn = document.createElement('span');
            pinBtn.className = 'action';
            pinBtn.dataset.action = 'adminPin';
            pinBtn.dataset.cid = c._id;
            pinBtn.textContent = Number(c.top) === 1 ? 'Unpin' : 'Pin';
            actions.appendChild(pinBtn);

            const delBtn = document.createElement('span');
            delBtn.className = 'action';
            delBtn.dataset.action = 'adminDel';
            delBtn.dataset.cid = c._id;
            delBtn.textContent = 'Delete';
            actions.appendChild(delBtn);
          }
        }

        // Toggle replies button next to Reply (if children exist)
        const count = c.children?.length || 0;
        if (count > 0) {
          const actions = node.querySelector('.actions');
          if (actions) {
            const toggleBtn = document.createElement('span');
            toggleBtn.className = 'action';
            toggleBtn.dataset.action = 'toggleReplies';
            toggleBtn.dataset.parent = c._id;
            toggleBtn.textContent = expanded.has(c._id)
              ? (count===1 ? 'Close Reply' : 'Close Replies')
              : (count===1 ? 'Show Reply' : 'Show Replies');
            actions.appendChild(toggleBtn);
          }
        }

        // Replies container under main bubble
        const cont = document.createElement("div");
        cont.className="replies";
        cont.id = "replies-"+c._id;
        if (expanded.has(c._id)) {
          buildReplies(cont, c);
          cont.style.display="flex";
        } else {
          cont.style.display="none";
        }
        const bubbleForReplies = node.querySelector('.bubble');
        (bubbleForReplies || node).appendChild(cont);

        frag.appendChild(node);
      }
      messagesEl.appendChild(frag);
      if (state.tops.length) { loadMoreBtn.style.display="inline-flex"; loadMoreBtn.disabled=false; loadMoreBtn.textContent="Load older"; }
      else { loadMoreBtn.style.display="none"; }

      updateAdminUI();
    }

    function renderMsg(c){
      const cid = c._id || c.id;
      const wrap=document.createElement("div"); wrap.className="msg"; wrap.dataset.cid=cid;

      const avatar=document.createElement("div"); avatar.className="avatar";
      if (c.avatar){ const img=new Image(); img.src=c.avatar; img.alt=c.nick||"avatar"; avatar.appendChild(img); }
      else { avatar.textContent = initialOf(c.nick); }

      const bubble=document.createElement("div"); bubble.className="bubble";
      const depth = Number(c.depth || 0);
      bubble.style.marginLeft = (depth * 20) + 'px';

      const meta=document.createElement("div"); meta.className="meta";
      const nick=document.createElement("span"); nick.className="nick"; nick.textContent=c.nick||"Anonymous";
      const time=document.createElement("span"); time.textContent=new Date(c.created||Date.now()).toLocaleString();
      meta.append(nick,time);

      const content=document.createElement("div"); content.className="content";
      if (c.parentNick) {
        const replyToSpan = document.createElement('div');
        replyToSpan.style.fontSize='12px';
        replyToSpan.style.color='var(--muted)';
        replyToSpan.textContent = `↪ Replying to ${c.parentNick}`;
        content.appendChild(replyToSpan);
      }
      const contentBody = document.createElement('div');
      contentBody.innerHTML=c.comment||"";
      content.appendChild(contentBody);

      const actions=document.createElement("div"); actions.className="actions";
      const replyBtn=document.createElement("span"); replyBtn.className="action"; replyBtn.dataset.action="reply"; replyBtn.textContent="↩ Reply";
      actions.append(replyBtn);

      bubble.append(meta,content,actions);
      wrap.append(avatar,bubble);
      return wrap;
    }

    function buildReplies(container, parent){
      container.innerHTML="";
      const kids = (parent.children||[]).slice().sort((a,b)=>(a.created||0)-(b.created||0));
      for (const ch of kids) container.appendChild(renderMsg(ch));
    }

    // ===== Loading =====
    async function loadLatest(){
      if (loading) return; loading=true;
      try{
        const r = await api({event:"COMMENT_GET", url: PAGE_URL_PATH});
        const list = Array.isArray(r?.data) ? r.data : [];
        mergeList(list);
        renderAll();
      }catch{ setStatus("Failed to load messages.", true); }
      finally{ loading=false; }
    }

    async function loadOlder(){
      if (loading || !earliestMainCreated) return;
      loading=true; loadMoreBtn.disabled=true; loadMoreBtn.textContent="Loading…";
      try{
        const r = await api({event:"COMMENT_GET", url: PAGE_URL_PATH, before: earliestMainCreated});
        const data = Array.isArray(r?.data) ? r.data : [];
        if (data.length){
          mergeList(data);
          renderAll();
          if (!earliestMainCreated){ loadMoreBtn.textContent="No more"; }
          else { loadMoreBtn.disabled=false; loadMoreBtn.textContent="Load older"; }
        }else{
          loadMoreBtn.textContent="No more";
        }
      }catch{
        setStatus("Failed loading older.", true);
        loadMoreBtn.disabled=false; loadMoreBtn.textContent="Load older";
      }finally{ loading=false; }
    }

    // ===== Actions =====
    function prettifyError(msg){
      if (!msg) return "Unexpected error";
      const m=String(msg);
      if (m.includes("发言频率过高")) return "You're sending too fast. Please wait a little and try again.";
      if (m.includes("评论太火爆")) return "Chat is busy right now — please try again in a moment.";
      if (m.includes("验证码")) return "Captcha check failed.";
      if (m.includes("未配置图片上传服务")) return "Image upload service is not configured.";
      if (m.includes("请先登录")) return "Please sign in first.";
      if (m.includes("密码错误")) return "Incorrect password.";
      if (m.includes("未配置管理密码")) return "Admin password is not set.";
      if (m.includes("数据库无配置")) return "Server configuration is missing.";
      if (m.includes("Too Many Requests")) return "Too many requests. Please slow down.";
      return m;
    }

    async function sendMessage(){
      const nickRaw = nickEl.value.trim();
      const nick = nickRaw || "Anonymous";
      if (isForbiddenNick(nick)) { setStatus("Nickname not allowed.", true); return; }

      const html = textEl.value.trim();
      if (!html){ setStatus("Type a message first.", true); return; }
      if (html.length > MAX_CHARS){ setStatus(`Message too long. Max ${MAX_CHARS} characters.`, true); return; }

      let pid, rid;
      if (replyTarget){
        const cid = replyTarget._id || replyTarget.id;
        pid = cid;
        rid = replyTarget.rid && replyTarget.rid !== "" ? replyTarget.rid : cid;
      }

      btnSend.disabled=true; btnSend.textContent="Sending…"; setStatus("Sending…");
      try{
        const payload = {event:"COMMENT_SUBMIT", nick, comment: html, url: PAGE_URL_PATH, href: PAGE_HREF, ua: navigator.userAgent};
        if (pid) payload.pid = pid;
        if (rid) payload.rid = rid;

        const r = await api(payload);
        if (r && r.id){
          if (pid){
            const rootToExpand = (rid && rid !== "") ? rid : pid;
            expanded.add(rootToExpand);
          }
          textEl.value=""; charCount.textContent="0"; fileEl.value=""; fileInfo.textContent=""; clearReplyTarget();
          await loadLatest();
          setStatus("");
        }else{
          throw new Error(prettifyError(r?.message || "Unknown error"));
        }
      }catch(e){ setStatus("Send failed: " + e.message, true); }
      finally{ btnSend.disabled=false; btnSend.textContent="Send"; }
    }

    async function attachImage(){
      const f = fileEl.files && fileEl.files[0];
      if (!f){ setStatus("Choose an image file first.", true); return; }
      if (!/^image\//.test(f.type)){ setStatus("Only image files are allowed.", true); return; }
      const maxBytes = MAX_FILE_MB * 1024 * 1024;
      if (f.size > maxBytes){ setStatus(`Image too large (>${MAX_FILE_MB} MB).`, true); return; }

      btnAttach.disabled=true; btnAttach.textContent="Uploading…"; setStatus("Uploading image…");
      try{
        const dataURL = await fileToDataURL(f);
        const r = await api({event:"UPLOAD_IMAGE", photo:dataURL});
        if (r?.code===0 && r?.data?.url){
          insertAtCursor(textEl, `\n<img src="${r.data.url}" alt="">\n`);
          charCount.textContent = String(textEl.value.length);
          setStatus("");
        }else{
          throw new Error(prettifyError(r?.err || r?.message || "Upload failed"));
        }
      }catch(e){ setStatus("Image upload failed: " + e.message, true); }
      finally{ btnAttach.disabled=false; btnAttach.textContent="Attach image"; }
    }

    function setReplyTarget(commentEl){
      const cid = commentEl?.dataset?.cid; if (!cid) return;
      const who = commentEl.querySelector('.nick')?.textContent || "someone";
      const obj = state.all.get(cid);
      const rootId = obj ? ((obj.rid && obj.rid !== "") ? obj.rid : (obj._id || obj.id)) : cid;
      replyTarget = { _id: cid, rid: rootId, nick: who };
      replyName.textContent = who;
      replyTo.style.display = "inline-flex";
      textEl.focus();
    }
    function clearReplyTarget(){ replyTarget=null; replyName.textContent=""; replyTo.style.display="none"; }

    // Admin actions
    async function adminTogglePin(id){
      const item = state.all.get(id);
      if (!item) return;
      const wantTop = Number(item.top) === 1 ? 0 : 1;
      const r = await api({event:'COMMENT_SET_FOR_ADMIN', id, set:{ top: wantTop }});
      if (r && r.code === 0) {
        await loadLatest();
      } else {
        setStatus(r?.message || 'Pin failed', true);
      }
    }
    async function adminDelete(id){
      const r = await api({event:'COMMENT_DELETE_FOR_ADMIN', id});
      if (r && r.code === 0) {
        await loadLatest();
      } else {
        setStatus(r?.message || 'Delete failed', true);
      }
    }

    // Events
    btnSend.addEventListener("click", sendMessage);
    btnAttach.addEventListener("click", attachImage);
    loadMoreBtn.addEventListener("click", loadOlder);
    replyCancel.addEventListener("click", clearReplyTarget);

    if (btnAdminLogin) btnAdminLogin.addEventListener('click', adminLogin);
    if (btnAdminLogout) btnAdminLogout.addEventListener('click', adminLogout);

    textEl.addEventListener("input", ()=>{
      const n=textEl.value.length; charCount.textContent=String(n);
      if (n>MAX_CHARS) setStatus(`Message too long. Max ${MAX_CHARS} characters.`, true);
      else if (statusEl.textContent.startsWith("Message too long")) setStatus("");
    });
    fileEl.addEventListener("change", ()=>{
      const f=fileEl.files&&fileEl.files[0];
      fileInfo.textContent = f ? `${f.name} · ${(f.size/1024/1024).toFixed(2)} MB` : "";
    });

    // Delegate actions
    messagesEl.addEventListener("click",(e)=>{
      const card = e.target.closest('.msg');
      const btn = e.target.closest('[data-action="reply"]');
      const toggle = e.target.closest('[data-action="toggleReplies"]');
      const pin = e.target.closest('[data-action="adminPin"]');
      const del = e.target.closest('[data-action="adminDel"]');

      if (btn && card){ setReplyTarget(card); return; }

      if (toggle){
        const pid = toggle.dataset.parent;
        if (!pid) return;
        const cont = document.getElementById("replies-"+pid);
        const parent = state.all.get(pid);
        if (!cont || !parent) return;

        if (expanded.has(pid)){
          cont.style.display="none";
          expanded.delete(pid);
        }else{
          if (!cont.childElementCount) buildReplies(cont, parent);
          cont.style.display="flex";
          expanded.add(pid);
        }
        const count = parent.children?.length || 0;
        toggle.textContent = expanded.has(pid)
          ? (count===1 ? 'Close Reply' : 'Close Replies')
          : (count===1 ? 'Show Reply' : 'Show Replies');
        return;
      }

      if (pin) { adminTogglePin(pin.dataset.cid); return; }
      if (del) { if (confirm('Delete this comment?')) adminDelete(del.dataset.cid); return; }
    });

    // Drag & drop image onto textarea
    textEl.addEventListener("dragover", e=>{ e.preventDefault(); });
    textEl.addEventListener("drop", async e=>{
      e.preventDefault();
      const f=e.dataTransfer?.files?.[0];
      if (f && f.type.startsWith("image/")){
        fileEl.files = e.dataTransfer.files;
        fileInfo.textContent = `${f.name} · ${(f.size/1024/1024).toFixed(2)} MB`;
        await attachImage();
      }
    });

    // Init
    (async ()=>{
      if (localStorage.getItem('twikoo_access_token')) {
        isAdmin = true;
        adminPanel.style.display = 'grid';
      }
      revealAdminIfRequested();
      updateAdminUI();
      await checkConnection();
      await loadLatest();
    })();
  })();
  </script>
</body>
</html>