<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chatboard</title>
  <style>
    :root {
      --bg:#0b1021; --panel:#121735; --muted:#7c86b2; --text:#e7eaf6; --accent:#7aa2ff; --danger:#ff6b6b;
      --border:#1d2450;
    }
    * { box-sizing:border-box }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--text); }
    header { padding:18px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; }
    header h1 { margin:0; font-size:18px; letter-spacing:.3px }
    .container { max-width:920px; margin:0 auto; padding:16px; display:grid; gap:16px; }
    .panel { background:var(--panel); border:1px solid var(--border); border-radius:16px; }
    #messages { padding:12px; display:flex; flex-direction:column; gap:10px; min-height:40vh; }
    .msg { display:flex; gap:10px; padding:10px 12px; border:1px solid var(--border); border-radius:12px; background:rgba(255,255,255,.02) }
    .avatar { width:38px; height:38px; border-radius:50%; background:#2a3164; display:flex; align-items:center; justify-content:center; font-weight:700; color:#c9d3ff; flex:0 0 38px; overflow:hidden }
    .avatar img { width:100%; height:100%; object-fit:cover }
    .bubble { flex:1; min-width:0 }
    .meta { font-size:12px; color:var(--muted); display:flex; gap:8px; align-items:center; }
    .nick { color:#cfe0ff; font-weight:600 }
    .content { margin-top:6px; line-height:1.5; word-wrap:break-word }
    .content img { max-width:420px; border-radius:10px; border:1px solid var(--border); display:block; margin:6px 0 }
    .children { margin-top:8px; padding-left:46px; display:flex; flex-direction:column; gap:8px }
    #composer { padding:12px; display:grid; gap:10px }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    input[type="text"], textarea {
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:#0f1440; color:var(--text);
    }
    textarea { min-height:100px; resize:vertical }
    button { padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:#1a235a; color:#fff; cursor:pointer }
    button.primary { background:linear-gradient(180deg,#3b63ff,#2748cf) }
    button:disabled { opacity:.6; cursor:not-allowed }
    #status { padding:10px 12px; border-top:1px solid var(--border); color:var(--muted); font-size:12px }
    #loadMore { margin:10px auto 14px; display:block }
    .row-slim { gap:6px }
    a { color:var(--accent) }
    .danger { color:var(--danger) }

    /* Themed "Choose image" button */
    #file { display:none }
    .file-btn { display:inline-flex; align-items:center; gap:8px; }
  </style>
</head>
<body>
  <header>
    <h1>Chatboard</h1>
    <div class="pill" style="font-size:11px; color:#9fb4ff; border:1px solid var(--border); background:#0f1440; padding:3px 8px; border-radius:999px">
      Connected: <span id="conn">checking…</span>
    </div>
  </header>

  <main class="container">
    <!-- Composer FIRST -->
    <section id="composer" class="panel">
      <div class="row">
        <input id="nick" type="text" placeholder="Nickname (optional, default Anonymous)" />
      </div>
      <div class="row">
        <textarea id="text" placeholder="Type your message… You can also attach an image."></textarea>
      </div>

      <div class="row row-slim">
        <input id="file" type="file" accept="image/*" />
        <button id="btnFile" class="file-btn" type="button">Choose image</button>
        <button id="btnAttach" type="button">Attach image</button>
        <button id="btnSend" class="primary" type="button">Send</button>
      </div>

      <div id="status">Ready.</div>
    </section>

    <!-- Comments AFTER composer -->
    <section class="panel">
      <div id="messages"></div>
      <button id="loadMore" class="primary" style="display:none">Load older</button>
    </section>
  </main>

  <script>
  ;(() => {
    // ====== EDIT THESE IF YOU MOVE HOST/PATH ======
    const WORKER_URL = "https://twikoo-cloudflare.ertertertet07.workers.dev";
    const PAGE_URL_PATH = "/chatboard/";
    const PAGE_HREF = "https://htmlunblockedgames.github.io/chatboard/";
    // ==============================================

    // DOM
    const $ = id => document.getElementById(id);
    const messagesEl = $("messages");
    const loadMoreBtn = $("loadMore");
    const nickEl = $("nick");
    const textEl = $("text");
    const fileEl = $("file");
    const btnFile = $("btnFile");
    const btnAttach = $("btnAttach");
    const btnSend = $("btnSend");
    const statusEl = $("status");
    const connEl = $("conn");

    // State
    let earliestMainCreated = null; // for pagination
    let loading = false;

    // Utils
    const setStatus = (t, isError=false) => {
      statusEl.textContent = t;
      statusEl.style.color = isError ? "var(--danger)" : "var(--muted)";
    };
    const fmtTime = ts => new Date(ts).toLocaleString();
    const initialOf = s => (s || "A").trim().charAt(0).toUpperCase();

    // API
    async function api(eventObj) {
      const res = await fetch(WORKER_URL, {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify(eventObj)
      });
      return res.json().catch(() => ({}));
    }

    async function checkConnection() {
      try {
        const r = await api({ event: "GET_FUNC_VERSION" });
        if (r && r.version) {
          connEl.textContent = `v${r.version}`;
          connEl.style.color = "#8ef5a9";
        } else {
          connEl.textContent = "ok";
        }
      } catch {
        connEl.textContent = "failed";
        connEl.style.color = "var(--danger)";
      }
    }

    async function loadLatest() {
      if (loading) return;
      loading = true;
      setStatus("Loading messages…");
      try {
        const r = await api({ event: "COMMENT_GET", url: PAGE_URL_PATH });
        renderComments(r?.data || []);
        const tops = (r?.data || []).filter(c => (c.rid || "") === "");
        if (tops.length) {
          earliestMainCreated = Math.min(...tops.map(c => c.created || Date.now()));
          loadMoreBtn.style.display = "inline-block";
        }
        setStatus("Loaded.");
      } catch {
        setStatus("Failed to load messages.", true);
      } finally { loading = false; }
    }

    async function loadOlder() {
      if (loading || !earliestMainCreated) return;
      loading = true;
      loadMoreBtn.disabled = true;
      loadMoreBtn.textContent = "Loading…";
      try {
        const r = await api({
          event: "COMMENT_GET",
          url: PAGE_URL_PATH,
          before: earliestMainCreated
        });
        const data = r?.data || [];
        if (data.length) {
          prependComments(data);
          const tops = data.filter(c => (c.rid || "") === "");
          if (tops.length) {
            earliestMainCreated = Math.min(earliestMainCreated, ...tops.map(c => c.created || Date.now()));
          }
        } else {
          loadMoreBtn.textContent = "No more";
          loadMoreBtn.disabled = true;
        }
      } catch {
        setStatus("Failed loading older.", true);
      } finally {
        loading = false;
        if (!loadMoreBtn.disabled) loadMoreBtn.textContent = "Load older";
      }
    }

    async function sendMessage() {
      const nick = nickEl.value.trim() || "Anonymous";
      const html = textEl.value.trim();
      if (!html) {
        setStatus("Type a message first.", true);
        return;
      }
      btnSend.disabled = true;
      btnSend.textContent = "Sending…";
      setStatus("Sending…");
      try {
        const r = await api({
          event: "COMMENT_SUBMIT",
          nick,
          comment: html,
          url: PAGE_URL_PATH,
          href: PAGE_HREF,
          ua: navigator.userAgent
        });
        if (r && r.id) {
          setStatus("Sent!");
          textEl.value = "";
          await loadLatest();
        } else {
          throw new Error(r?.message || "Unknown error");
        }
      } catch (e) {
        setStatus("Send failed: " + e.message, true);
      } finally {
        btnSend.disabled = false;
        btnSend.textContent = "Send";
      }
    }

    async function chooseFile() {
      fileEl.click();
    }

    async function attachImage() {
      const f = fileEl.files && fileEl.files[0];
      if (!f) { setStatus("Choose an image file first.", true); return; }
      btnAttach.disabled = true;
      btnAttach.textContent = "Uploading…";
      setStatus("Uploading image…");
      try {
        const dataURL = await fileToDataURL(f);
        const r = await api({ event: "UPLOAD_IMAGE", photo: dataURL });
        if (r?.code === 0 && r?.data?.url) {
          const url = r.data.url;
          insertAtCursor(textEl, `\n<img src="${url}" alt="">\n`);
          setStatus("Image attached.");
        } else {
          throw new Error(r?.err || r?.message || "Upload failed");
        }
      } catch (e) {
        setStatus("Image upload failed: " + e.message, true);
      } finally {
        btnAttach.disabled = false;
        btnAttach.textContent = "Attach image";
        fileEl.value = "";
      }
    }

    // Rendering
    function renderComments(list) {
      messagesEl.innerHTML = "";
      appendComments(list);
    }

    function appendComments(list) {
      const tops = list.filter(c => (c.rid || "") === "");
      for (const c of tops) {
        messagesEl.appendChild(renderMsg(c));
        if (Array.isArray(c.children)) {
          const childrenWrap = document.createElement("div");
          childrenWrap.className = "children";
          for (const ch of c.children) {
            childrenWrap.appendChild(renderMsg(ch, true));
          }
          messagesEl.lastElementChild.appendChild(childrenWrap);
        }
      }
    }

    function prependComments(list) {
      const frag = document.createDocumentFragment();
      const tops = list.filter(c => (c.rid || "") === "");
      for (const c of tops) {
        const node = renderMsg(c);
        if (Array.isArray(c.children) && c.children.length) {
          const childrenWrap = document.createElement("div");
          childrenWrap.className = "children";
          for (const ch of c.children) childrenWrap.appendChild(renderMsg(ch, true));
          node.appendChild(childrenWrap);
        }
        frag.appendChild(node);
      }
      messagesEl.prepend(frag);
    }

    function renderMsg(c) {
      const wrap = document.createElement("div");
      wrap.className = "msg";

      const avatar = document.createElement("div");
      avatar.className = "avatar";
      if (c.avatar) {
        const img = document.createElement("img");
        img.src = c.avatar;
        img.alt = c.nick || "avatar";
        avatar.appendChild(img);
      } else {
        avatar.textContent = initialOf(c.nick);
      }

      const bubble = document.createElement("div");
      bubble.className = "bubble";

      const meta = document.createElement("div");
      meta.className = "meta";
      const nick = document.createElement("span");
      nick.className = "nick";
      nick.textContent = c.nick || "Anonymous";
      const time = document.createElement("span");
      time.textContent = fmtTime(c.created || Date.now());
      meta.appendChild(nick);
      meta.appendChild(time);

      const content = document.createElement("div");
      content.className = "content";
      content.innerHTML = c.comment || "";

      bubble.appendChild(meta);
      bubble.appendChild(content);

      wrap.appendChild(avatar);
      wrap.appendChild(bubble);
      return wrap;
    }

    // Helpers
    function fileToDataURL(file) {
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onerror = () => reject(fr.error || new Error("FileReader error"));
        fr.onload = () => resolve(fr.result);
        fr.readAsDataURL(file);
      });
    }

    function insertAtCursor(el, text) {
      const [start, end] = [el.selectionStart ?? el.value.length, el.selectionEnd ?? el.value.length];
      el.value = el.value.slice(0, start) + text + el.value.slice(end);
      const pos = start + text.length;
      el.setSelectionRange(pos, pos);
      el.focus();
    }

    // Wire up
    btnSend.addEventListener("click", sendMessage);
    btnFile.addEventListener("click", chooseFile);
    btnAttach.addEventListener("click", attachImage);
    loadMoreBtn.addEventListener("click", loadOlder);

    // Drag & drop support
    textEl.addEventListener("dragover", e => { e.preventDefault(); });
    textEl.addEventListener("drop", async e => {
      e.preventDefault();
      const f = e.dataTransfer?.files?.[0];
      if (f && f.type.startsWith("image/")) {
        fileEl.files = e.dataTransfer.files;
        await attachImage();
      }
    });

    // Init
    checkConnection();
    loadLatest();
  })();
  </script>
</body>
</html>
