<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Poly Track Chatboard</title>
  <style>
    /* ---------- Purple (Google-Forms-ish) dark theme ---------- */
    :root{
      --bg:#1a1426;            /* page background */
      --panel:#211a35;         /* card background */
      --panel-2:#271f41;
      --border:#3a2f5f;
      --text:#ecedff;
      --muted:#a8a2c7;
      --accent:#a78bfa;        /* lavender */
      --accent-2:#8b5cf6;      /* focus/hover */
      --ok:#4ade80;            /* green */
      --danger:#ff7b8a;
      --inner:16px;            /* inner horizontal padding used by lists */
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 80% -10%, #2b2351 0%, transparent 60%) , var(--bg);
      color:var(--text);
      letter-spacing:.1px;
    }

    /* ---------- Header ---------- */
    header{
      padding:18px 16px;
      border-bottom:1px solid var(--border);
      display:flex;align-items:center;justify-content:space-between;
      background:linear-gradient(180deg,#2a2250,#20193b);
    }
    header h1{margin:0;font-size:18px;font-weight:700}
    .status{
      font-size:12px;padding:6px 12px;border:1px solid var(--border);
      border-radius:999px;background:var(--panel-2);
    }
    .status.ok{color:var(--ok)}
    .status.bad{color:var(--danger)}

    /* ---------- Layout ---------- */
    .container{max-width:920px;margin:0 auto;padding:20px;display:grid;gap:18px}
    .panel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }

    /* ---------- Composer ---------- */
    #composer{padding:18px;display:grid;gap:12px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row-slim{gap:8px}
    input[type="text"], textarea{
      width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--border);
      background:linear-gradient(180deg,#1a1640,#141032);color:var(--text);
      outline:none;transition:border-color .15s, box-shadow .15s;
    }
    input[type="text"]:focus, textarea:focus{
      border-color:var(--accent); box-shadow:0 0 0 3px rgba(167,139,250,.15)
    }
    textarea{min-height:120px;resize:vertical;line-height:1.55}

    .btn{
      padding:10px 14px;border-radius:12px;border:1px solid var(--border);
      background:#2a2361;color:#fff;cursor:pointer;
      transition:transform .05s ease, background .15s, border-color .15s;
    }
    .btn:hover{background:#2f2770;border-color:#4a3b85}
    .btn:active{transform:translateY(1px)}
    .btn.primary{
      background:linear-gradient(180deg,var(--accent),var(--accent-2));
      border-color:#5b46c9;
    }
    .btn.primary:hover{filter:brightness(1.03)}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    /* Custom file input */
    #file{display:none}
    .file-btn{display:inline-block}
    .file-name{font-size:12px;color:var(--muted)}
    .limits{font-size:12px;color:var(--muted)}

    /* Status (inline, only when needed) */
    #status{display:none;font-size:12px;color:var(--muted)}

    /* ---------- Messages ---------- */
    #messages{padding:12px var(--inner);display:flex;flex-direction:column;gap:12px;min-height:36vh}
    .msg{
      display:flex;gap:12px;padding:12px 14px;border:1px solid var(--border);
      border-radius:14px;background:linear-gradient(180deg,#231d42,#1c1736);
    }
    .avatar{
      width:40px;height:40px;border-radius:50%;
      background:#3b2f74;display:flex;align-items:center;justify-content:center;
      font-weight:800;color:#d9d4ff;flex:0 0 40px;overflow:hidden
    }
    .avatar img{width:100%;height:100%;object-fit:cover}
    .bubble{flex:1;min-width:0}
    .meta{font-size:12px;color:var(--muted);display:flex;gap:10px;align-items:center}
    .nick{color:#e5ddff;font-weight:700}
    .content{margin-top:6px;line-height:1.58;word-wrap:break-word}
    .content img{max-width:440px;border-radius:10px;border:1px solid var(--border);display:block;margin:8px 0}
    .children{margin-top:10px;padding-left:52px;display:flex;flex-direction:column;gap:10px}

    /* Load more spans the same inner width as bubbles */
    #loadMore{
      display:none;margin:8px var(--inner) 18px;
      width:calc(100% - var(--inner)*2);
      text-align:center
    }

    /* Small helpers */
    .right{margin-left:auto}
    a{color:var(--accent)}
  </style>
</head>
<body>
  <header>
    <h1>Poly Track Chatboard</h1>
    <div id="conn" class="status">Status: checking…</div>
  </header>

  <main class="container">
    <!-- Composer -->
    <section id="composer" class="panel">
      <div class="row">
        <input id="nick" type="text" placeholder="Nickname (optional, default Anonymous)"/>
      </div>
      <div class="row">
        <textarea id="text" placeholder="Type your message… You can also attach an image."></textarea>
      </div>
      <div class="row row-slim">
        <label for="file" class="btn file-btn" id="btnChoose">Choose image</label>
        <input id="file" type="file" accept="image/*"/>
        <span id="fileInfo" class="file-name"></span>
        <button id="btnAttach" class="btn">Attach image</button>
        <div class="right">
          <button id="btnSend" class="btn primary">Send</button>
        </div>
      </div>
      <div class="row row-slim" style="margin-top:-2px">
        <span id="limits" class="limits">
          Images: PNG/JPG/GIF/WebP ≤ <span id="limitMb">5</span> MB · Message limit: <span id="limitChars">2000</span> chars · <span id="charCount">0</span>/<span id="limitChars2">2000</span>
        </span>
        <span id="status" class="right"></span>
      </div>
    </section>

    <!-- Messages -->
    <section class="panel">
      <div id="messages"></div>
      <button id="loadMore" class="btn primary">Load older</button>
    </section>
  </main>

  <script>
  ;(() => {
    // ====== EDIT THESE IF YOU MOVE HOST/PATH ======
    const WORKER_URL   = "https://twikoo-cloudflare.ertertertet07.workers.dev";
    const PAGE_URL_PATH= "/chatboard/";
    const PAGE_HREF    = "https://htmlunblockedgames.github.io/chatboard/";
    // Limits (client-side)
    const MAX_FILE_MB  = 5;         // shown + enforced locally
    const MAX_CHARS    = 2000;      // shown + enforced locally
    // ==============================================

    // DOM
    const $=id=>document.getElementById(id);
    const messagesEl = $("messages");
    const loadMoreBtn= $("loadMore");
    const nickEl     = $("nick");
    const textEl     = $("text");
    const fileEl     = $("file");
    const btnChoose  = $("btnChoose");
    const btnAttach  = $("btnAttach");
    const btnSend    = $("btnSend");
    const fileInfo   = $("fileInfo");
    const statusEl   = $("status");
    const connEl     = $("conn");
    const limitMbEl  = $("limitMb");
    const limitChars = $("limitChars");
    const limitChars2= $("limitChars2");
    const charCount  = $("charCount");

    // State
    let earliestMainCreated=null;
    let loading=false;
    let TK_TOKEN = localStorage.getItem('twikoo_access_token') || null;

    // Init limits text
    limitMbEl.textContent = MAX_FILE_MB;
    limitChars.textContent = MAX_CHARS;
    limitChars2.textContent = MAX_CHARS;

    // Status helper
    const setStatus=(t,isError=false)=>{
      if(!t){ statusEl.style.display="none"; statusEl.textContent=""; return; }
      statusEl.style.display="inline";
      statusEl.textContent=t;
      statusEl.style.color = isError ? "var(--danger)" : "var(--muted)";
    };

    // API with token persistence
    async function api(eventObj){
      const body = {...eventObj};
      if (TK_TOKEN) body.accessToken = TK_TOKEN;

      const res = await fetch(WORKER_URL,{
        method:"POST",
        headers:{"content-type":"application/json"},
        body:JSON.stringify(body)
      });
      const json = await res.json().catch(()=>({}));
      if (json && json.accessToken){
        TK_TOKEN = json.accessToken;
        localStorage.setItem('twikoo_access_token', TK_TOKEN);
      }
      return json;
    }

    async function checkConnection(){
      try{
        await api({event:"GET_FUNC_VERSION"});
        connEl.textContent = "Status: Online";
        connEl.classList.remove("bad"); connEl.classList.add("ok");
      }catch{
        connEl.textContent = "Status: Offline";
        connEl.classList.remove("ok"); connEl.classList.add("bad");
      }
    }

    async function loadLatest(){
      if (loading) return;
      loading = true;
      try{
        const r = await api({event:"COMMENT_GET", url: PAGE_URL_PATH});
        const list = Array.isArray(r?.data) ? r.data : [];
        renderComments(list);
        const tops = list.filter(c => (c.rid||"")==="");
        if (tops.length){
          earliestMainCreated = Math.min(...tops.map(c=>c.created||Date.now()));
          loadMoreBtn.style.display="block";
          loadMoreBtn.disabled=false;
          loadMoreBtn.textContent="Load older";
        }else{
          earliestMainCreated = null;
          loadMoreBtn.style.display="none";
        }
      }catch(e){
        setStatus("Failed to load messages.", true);
      }finally{
        loading=false;
      }
    }

    async function loadOlder(){
      if (loading || !earliestMainCreated) return;
      loading = true;
      loadMoreBtn.disabled=true;
      loadMoreBtn.textContent="Loading…";
      try{
        const r = await api({event:"COMMENT_GET", url: PAGE_URL_PATH, before: earliestMainCreated});
        const data = Array.isArray(r?.data) ? r.data : [];
        if (data.length){
          appendComments(data);
          const tops = data.filter(c => (c.rid||"")==="");
          if (tops.length){
            earliestMainCreated = Math.min(earliestMainCreated, ...tops.map(c=>c.created||Date.now()));
            loadMoreBtn.disabled=false;
            loadMoreBtn.textContent="Load older";
          }else{
            loadMoreBtn.textContent="No more";
          }
        }else{
          loadMoreBtn.textContent="No more";
        }
      }catch(e){
        setStatus("Failed loading older.", true);
        loadMoreBtn.disabled=false;
        loadMoreBtn.textContent="Load older";
      }finally{
        loading=false;
      }
    }

    // Send
    async function sendMessage(){
      const nick = nickEl.value.trim() || "Anonymous";
      const html = textEl.value.trim();

      if (!html){ setStatus("Type a message first.", true); return; }
      if (html.length > MAX_CHARS){ setStatus(`Message too long. Max ${MAX_CHARS} characters.`, true); return; }

      btnSend.disabled=true; btnSend.textContent="Sending…"; setStatus("Sending…");
      try{
        const r = await api({event:"COMMENT_SUBMIT", nick, comment: html, url: PAGE_URL_PATH, href: PAGE_HREF, ua: navigator.userAgent});
        if (r && r.id){
          textEl.value=""; charCount.textContent="0";
          fileEl.value=""; fileInfo.textContent="";
          await loadLatest();
          setStatus(""); // clear
        }else{
          const raw = r?.message || "Unknown error";
          throw new Error(prettifyError(raw));
        }
      }catch(e){
        setStatus("Send failed: " + e.message, true);
      }finally{
        btnSend.disabled=false; btnSend.textContent="Send";
      }
    }

    // Attach image
    async function attachImage(){
      const f = fileEl.files && fileEl.files[0];
      if (!f){ setStatus("Choose an image file first.", true); return; }
      if (!/^image\//.test(f.type)){ setStatus("Only image files are allowed.", true); return; }
      const maxBytes = MAX_FILE_MB * 1024 * 1024;
      if (f.size > maxBytes){ setStatus(`Image too large (>${MAX_FILE_MB} MB).`, true); return; }

      btnAttach.disabled=true; btnAttach.textContent="Uploading…"; setStatus("Uploading image…");
      try{
        const dataURL = await fileToDataURL(f);
        const r = await api({event:"UPLOAD_IMAGE", photo:dataURL});
        if (r?.code===0 && r?.data?.url){
          insertAtCursor(textEl, `\n<img src="${r.data.url}" alt="">\n`);
          charCount.textContent = String(textEl.value.length);
          setStatus(""); // clear
        }else{
          throw new Error(r?.err || r?.message || "Upload failed");
        }
      }catch(e){
        setStatus("Image upload failed: " + e.message, true);
      }finally{
        btnAttach.disabled=false; btnAttach.textContent="Attach image";
      }
    }

    // Friendly error translations
    function prettifyError(msg){
      if (!msg) return "Unexpected error";
      if (msg.includes("发言频率过高")) return "You're sending too fast. Please wait a little and try again.";
      if (msg.includes("评论太火爆")) return "Chat is busy right now — please try again in a moment.";
      if (msg.includes("验证码")) return "Captcha check failed.";
      return msg;
    }

    // Render
    function renderComments(list){
      messagesEl.innerHTML="";
      appendComments(list);
    }
    function appendComments(list){
      const tops = list.filter(c => (c.rid||"")==="");
      for (const c of tops){
        messagesEl.appendChild(renderMsg(c));
        if (Array.isArray(c.children) && c.children.length){
          const childrenWrap=document.createElement("div");
          childrenWrap.className="children";
          for (const ch of c.children) childrenWrap.appendChild(renderMsg(ch,true));
          messagesEl.lastElementChild.appendChild(childrenWrap);
        }
      }
    }
    function renderMsg(c,isChild=false){
      const wrap=document.createElement("div"); wrap.className="msg";
      const avatar=document.createElement("div"); avatar.className="avatar";
      if (c.avatar){ const img=new Image(); img.src=c.avatar; img.alt=c.nick||"avatar"; avatar.appendChild(img); }
      else { avatar.textContent = initialOf(c.nick); }

      const bubble=document.createElement("div"); bubble.className="bubble";
      const meta=document.createElement("div"); meta.className="meta";
      const nick=document.createElement("span"); nick.className="nick"; nick.textContent=c.nick||"Anonymous";
      const time=document.createElement("span"); time.textContent=new Date(c.created||Date.now()).toLocaleString();
      meta.append(nick,time);

      const content=document.createElement("div"); content.className="content";
      content.innerHTML = c.comment || "";

      bubble.append(meta,content);
      wrap.append(avatar,bubble);
      return wrap;
    }

    // Helpers
    const initialOf = s => (s||"A").trim().charAt(0).toUpperCase();
    function fileToDataURL(file){
      return new Promise((resolve,reject)=>{
        const fr=new FileReader();
        fr.onerror=()=>reject(fr.error||new Error("FileReader error"));
        fr.onload =()=>resolve(fr.result);
        fr.readAsDataURL(file);
      });
    }
    function insertAtCursor(el,text){
      const [start,end]=[el.selectionStart??el.value.length, el.selectionEnd??el.value.length];
      el.value = el.value.slice(0,start)+text+el.value.slice(end);
      const pos=start+text.length; el.setSelectionRange(pos,pos); el.focus();
    }

    // Wire up
    btnSend.addEventListener("click", sendMessage);
    btnAttach.addEventListener("click", attachImage);
    loadMoreBtn.addEventListener("click", loadOlder);
    textEl.addEventListener("input", ()=>{ charCount.textContent=String(textEl.value.length); if (textEl.value.length>MAX_CHARS){ setStatus(`Message too long. Max ${MAX_CHARS} characters.`, true);} else if (statusEl.textContent.startsWith("Message too long")){ setStatus(""); }});
    fileEl.addEventListener("change", ()=>{
      const f=fileEl.files&&fileEl.files[0];
      if (!f){ fileInfo.textContent=""; return; }
      const sizeMb=(f.size/1024/1024).toFixed(2);
      fileInfo.textContent = `${f.name} · ${sizeMb} MB`;
    });
    // drag & drop onto textarea
    textEl.addEventListener("dragover", e=>{ e.preventDefault(); });
    textEl.addEventListener("drop", async e=>{
      e.preventDefault();
      const f=e.dataTransfer?.files?.[0];
      if (f && f.type.startsWith("image/")){
        fileEl.files = e.dataTransfer.files;
        const sizeMb=(f.size/1024/1024).toFixed(2);
        fileInfo.textContent = `${f.name} · ${sizeMb} MB`;
        await attachImage();
      }
    });

    // Init
    checkConnection();
    loadLatest();
  })();
  </script>
</body>
</html>
