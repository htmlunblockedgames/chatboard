<!doctype html>
<html lang="en">
<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-BNGS3T0Q2F"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-BNGS3T0Q2F');
  </script>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Poly Track Chatboard</title>
  <style>
    /* ===== Site Palette ===== */
    :root{
      --bg:#fafafa; --panel:#ffffff; --panel-2:#f5f5f5;
      --border:#dadce0; --border-2:#e0e0e0;
      --text:#1f2125; --muted:#5f6369;
      --accent:#2694d5; --accent-2:#0280ca;
      --ok:#0f9d58; --danger:#d93025;
      --radius:12px; --inner:14px;
      --shadow:0 8px 18px rgba(0,0,0,.05);
      --shimmer-x: 0%;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      font-weight:600; color:var(--text); background:var(--bg);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      letter-spacing:.1px;
    }

    /* Layout */
    .container{max-width:920px;margin:0 auto;padding:20px;display:grid;gap:18px}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}

    /* Admin panel (hidden by default; JS reveals only on ?admin=1 at /chatboard/) */
    #adminPanel{padding:18px;display:none;gap:10px}
    #adminPanel .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    #adminNote{font-size:12px;color:var(--muted)}
    .admin-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .tag{font-size:11px;border:1px solid var(--border-2);border-radius:999px;padding:3px 8px;color:var(--muted);background:#f9fafb}
    #conn.ok{ color: var(--ok); border-color:#c7e8d5; background:#eaf7f0; }
    #conn.bad{ color: var(--danger); border-color:#f7c7c5; background:#fdecea; }

    /* Admin cleanup panel */
    #cleanupPanel{padding:18px;display:none;flex-direction:column;gap:12px}
    #cleanupPanel h3{margin:0;font-size:16px}
    .cleanup-controls{gap:8px;align-items:flex-end}
    .cleanup-controls .field{display:flex;flex-direction:column;gap:6px;font-size:12px;color:var(--muted)}
    .cleanup-controls input{min-width:200px}
    .cleanup-actions{display:flex;gap:10px;flex-wrap:wrap}
    .btn.danger{background:#fdecea;color:var(--danger);border-color:#f7c7c5}
    .btn.danger:hover{background:#f9d8d3}
    #cleanupStatus{font-size:12px;color:var(--muted)}
    #cleanupStatus.error{color:var(--danger)}
    .cleanup-results{border:1px solid var(--border);border-radius:12px;padding:10px;background:var(--panel-2);display:flex;flex-direction:column;gap:10px;max-height:320px;overflow:auto}
    .cleanup-results.empty{padding:18px;background:#fafbff;color:var(--muted);font-size:13px;text-align:center}
    .cleanup-row{display:flex;gap:10px;align-items:flex-start;padding:10px;border-radius:10px;background:#fff;border:1px solid var(--border-2)}
    .cleanup-row mark{background:#fff4c4}
    .cleanup-row .cleanup-body{flex:1;display:flex;flex-direction:column;gap:6px}
    .cleanup-snippet{font-size:13px;line-height:1.5;color:var(--text);word-break:break-word}
    .cleanup-meta{font-size:11px;color:var(--muted);display:flex;gap:10px;flex-wrap:wrap}

    /* Composer */
    #composer{padding:18px;display:grid;gap:12px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row-slim{gap:8px}
    input[type="text"], textarea{
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--border);
      background:var(--panel-2); color:var(--text); outline:none;
      transition:border-color .15s, box-shadow .15s, background .2s;
      font-size:14px; font-weight:600;
    }
    input[type="text"]:focus, textarea:focus{
      border-color:var(--accent); box-shadow:0 0 0 3px #2694d522; background:#fff;
    }
    textarea{min-height:120px; resize:vertical; line-height:1.58}

    /* Buttons */
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:10px 14px; border-radius:12px; border:1px solid var(--border);
      background:#eaf5fc; color:#0f3c55; cursor:pointer;
      transition:transform .05s ease, background .15s, border-color .15s, color .15s;
      font-weight:700; font-size:14px; line-height:1; min-width:140px; height:40px;
      text-align:center; user-select:none;
    }
    .btn:hover{background:#dff0fb;border-color:#cfe8f8}
    .btn:active{transform:translateY(1px)}
    .btn.primary{
      background:linear-gradient(180deg,var(--accent),var(--accent-2));
      border-color:#197fb4; color:#fff;
    }
    .btn.primary:hover{filter:brightness(1.03)}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    /* Custom file input */
    #file{display:none}
    .file-btn{display:inline-flex}
    .file-name{font-size:12px;color:var(--muted)}

    /* Inline status */
    #status{display:none;font-size:12px;color:var(--muted)}

    /* Reply pill */
    #replyTo{
      display:none; font-size:12px; color:var(--muted);
      background:#f9f9f9; border:1px solid var(--border-2); padding:6px 10px;
      border-radius:999px;
    }
    #replyCancel{margin-left:8px;color:var(--accent);cursor:pointer;font-weight:800}

    /* Messages */
    #messages{padding:14px var(--inner);display:flex;flex-direction:column;gap:14px;min-height:36vh}
    .msg{
      position:relative;
      display:flex; gap:12px; padding:12px 14px; border:1px solid var(--border);
      border-radius:14px; background:#fff;
    }
    .pin-badge{
      position:absolute;
      top:12px; right:8px;
      font-size:11px; font-weight:800;
      color:#8a6a00;
      background:#fff6c2;
      border:1px solid #f0d46a;
      padding:2px 6px;
      border-radius:999px;
      box-shadow:0 1px 2px rgba(0,0,0,.06);
      pointer-events:none;
    }
    .avatar{
      width:40px; height:40px; border-radius:50%;
      background:#b3c1fe22; display:flex; align-items:center; justify-content:center;
      font-weight:900; color:#1f2127; flex:0 0 40px; overflow:hidden; border:1px solid #b3c1fe66;
    }
    .avatar img{width:100%;height:100%;object-fit:cover}
    .bubble{flex:1;min-width:0}
    .meta{font-size:12px;color:var(--muted);display:flex;gap:10px;align-items:center}
    .nick{color:#1f2127;font-weight:800}
    .content{margin-top:6px;line-height:1.58;word-wrap:break-word;overflow-wrap:anywhere;word-break:break-word; position:relative}
    .content img{max-width:480px;border-radius:10px;border:1px solid var(--border);display:block;margin:8px 0;background:#fafafa}

    .poll-card{margin-top:8px;padding:12px 14px;border:1px solid var(--border);border-radius:12px;background:#f7fbff;display:flex;flex-direction:column;gap:10px;position:relative;overflow:hidden}
    .poll-question{font-size:14px;font-weight:800;color:#0f3c55}
    .poll-options{display:flex;flex-direction:column;gap:8px}
    .poll-option{position:relative;padding:10px 12px;border:1px solid var(--border-2);border-radius:10px;background:#fff;display:flex;justify-content:space-between;align-items:center;gap:10px;font-size:13px;cursor:pointer;overflow:hidden;transition:border-color .15s, background .15s, color .15s}
    .poll-option .bar{position:absolute;inset:0;background:linear-gradient(90deg,rgba(38,148,213,.18),rgba(2,128,202,.22));opacity:0.6;transform-origin:left;transition:transform .3s;width:var(--pct,0%);pointer-events:none}
    .poll-option .label{position:relative;z-index:1;font-weight:700;color:inherit;flex:1;text-align:left}
    .poll-option .votes{position:relative;z-index:1;font-size:11px;color:var(--muted);font-weight:700}
    .poll-option.selected{border-color:var(--accent);color:#0f3c55;background:#eaf5fc}
    .poll-option.closed{cursor:default;opacity:.7}
    .poll-option.can-vote:hover{border-color:var(--accent);background:#edf7ff}
    .poll-meta{font-size:11px;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap}
    .poll-meta strong{color:#0f3c55}

    /* Replying-to line */
    .replying-to{
      font-size:12px;
      color:var(--muted);
      margin-bottom:4px;
      padding-left:6px;
      border-left:2px solid #eceff3;
    }

    /* Actions */
    .actions{display:flex;gap:14px;align-items:center;margin-top:8px;flex-wrap:wrap}
    .action{
      font-size:12px;color:var(--accent);cursor:pointer;font-weight:800;
      background:#fdfdfd;border:1px solid var(--border-2);padding:6px 10px;border-radius:999px;
      user-select:none;
    }
    .action:hover{background:#f8f8f8}
    .action.like-button{display:inline-flex;align-items:center;gap:6px;min-width:56px;justify-content:center;transition:color .2s, border-color .2s;}
    .action.like-button .heart{font-size:14px;transition:transform .2s,color .2s;}
    .action.like-button .count{font-size:12px;min-width:1.2em;text-align:center;}
    .action.like-button.liked{color:#d93025;border-color:#f5b7af;background:#fdecea;}
    .action.like-button.liked .heart{color:#d93025;transform:scale(1.1);}
    .action.like-button.loading{opacity:.6;pointer-events:none;}

    .sort-panel{display:flex;align-items:center;gap:12px;padding:12px 18px;margin-top:-6px}
    .sort-panel .label{font-size:12px;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.08em}
    .sort-buttons{display:inline-flex;gap:8px}
    .sort-btn{
      padding:6px 14px;border-radius:999px;border:1px solid var(--border);
      background:#f5f7fa;color:var(--muted);font-size:12px;font-weight:700;cursor:pointer;
      transition:background .15s,border-color .15s,color .15s;
    }
    .sort-btn:hover{background:#e9f1fb;border-color:#cde1ff;color:#0f3c55}
    .sort-btn.active{background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#fff;border-color:#197fb4;box-shadow:0 4px 10px rgba(38,148,213,.25);}

    .room-panel{display:flex;align-items:center;gap:12px;padding:12px 18px;margin-top:-6px}
    .room-panel .label{font-size:12px;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.08em}
    .room-buttons{display:flex;gap:8px;flex-wrap:wrap}
    .room-btn{
      padding:6px 14px;border-radius:999px;border:1px solid var(--border);
      background:#f5f7fa;color:var(--muted);font-size:12px;font-weight:700;cursor:pointer;
      transition:background .15s,border-color .15s,color .15s;
    }
    .room-btn:hover{background:#e9f1fb;border-color:#cde1ff;color:#0f3c55}
    .room-btn.active{background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#fff;border-color:#197fb4;box-shadow:0 4px 10px rgba(38,148,213,.25);}

    /* Replies container */
    .replies{display:none; margin-top:10px; margin-left:52px; padding-left:0; flex-direction:column; gap:10px}

    /* Load older */
    #loadMore{
      display:none; margin:8px var(--inner) 18px;
      width:calc(100% - var(--inner)*2);
    }

    .limits{font-size:12px;color:var(--muted)}
    a{color:var(--accent)}

    /* ===== Admin visuals ===== */
    body.is-admin{
      background:
        radial-gradient(1200px 600px at 10% -10%, #d2efff66, transparent 60%),
        radial-gradient(900px 500px at 120% 20%, #ffe8a366, transparent 60%),
        linear-gradient(180deg,#f7fbff,#f9f9ff);
      animation: bgShift 18s ease-in-out infinite alternate;
      background-attachment: fixed;
    }
    @keyframes bgShift{
      0%{ background-position: 0 0, 0 0, 0 0; }
      100%{ background-position: 10px -10px, -12px 16px, 0 0; }
    }

    /* Admin avatar shimmer */
    .avatar.admin{
      position: relative;
      background: radial-gradient(circle at 30% 30%, #fff6c2, #ffd84a 40%, #f8b500 70%);
      border-color:#f5c400;
      color:#2a1f00;
      font-weight:900;
      letter-spacing:.5px;
      box-shadow: inset 0 0 0 1px #f5c400, 0 0 10px rgba(245,196,0,.14);
      overflow: hidden;
      font-size: 13px;
      line-height: 1;
    }
    .avatar.admin::after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,235,130,.65) 50%, rgba(255,255,255,0) 100%);
      transform: translateX(-120%);
      mix-blend-mode: screen;
      pointer-events:none;
      animation: avatarSweep var(--glow-avatar-dur, 3.2s) ease-in-out infinite;
    }
    @keyframes avatarSweep{ to { transform: translateX(120%); } }

    /* Admin username – dimmer, indefinite shimmer (uses global --shimmer-x) */
    .nick.admin-glow{
      color: transparent;
      background: linear-gradient(90deg,
        #9e7f00 0%,
        #d7bf52 20%,
        #ffe48a 50%,
        #d7bf52 80%,
        #9e7f00 100%);
      background-size: 200% 100%;
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      background-position: var(--shimmer-x, 0%) 0;
      text-shadow: 0 0 3px rgba(245,196,0,.12), 0 0 6px rgba(245,196,0,.06);
      will-change: background-position, text-shadow;
    }

    /* Restored text glow overlay: one sweep, then smooth fade-out (no white flash) */
    .glow-overlay{
      position:absolute;
      inset:0;
      display:inline-block;  /* ensure background-clip:text paints */
      width:100%;
      height:100%;
      pointer-events:none;
      white-space:pre-wrap;
      color:transparent;
      background: linear-gradient(90deg,
        #8f7200 0%,
        #d9c056 18%,
        #ffe48a 45%,
        #d9c056 82%,
        #8f7200 100%);
      background-size:200% 100%;
      -webkit-background-clip:text;
      background-clip:text;
      -webkit-text-fill-color: transparent;
      background-position:-60% 0;
      animation: glowSweep var(--glow-dur, 2s) ease-in-out forwards;
      opacity: var(--glow-ol-opacity, 1);
      transition: opacity 1.5s ease-in-out; /* smooth fade after sweep */
      will-change: background-position, opacity;
      z-index: 1;
      line-height: inherit;
    }
    @keyframes glowSweep {
      0%   { background-position: -60% 0; }
      100% { background-position: 160% 0; }
    }

    /* ===== Compact message layout (fits more per page) ===== */
    #messages{ padding:10px var(--inner); gap:8px; }
    .msg{ padding:8px 10px; border-radius:12px; }
    .pin-badge{ top:4px; right:6px; font-size:10px; padding:1px 6px; }
    .avatar{ width:32px; height:32px; flex:0 0 32px; }
    .meta{ font-size:11px; gap:8px; }
    .content{ margin-top:4px; line-height:1.4; }
    .content .glow-target{
      position: relative;
      display: inline-block;
      vertical-align: baseline;
      contain: layout paint;
      overflow-wrap:anywhere;
      word-break:break-word;
    }
    .content img{ max-width:420px; margin:6px 0; }
    .actions{ margin-top:4px; gap:10px; }
    .action{ font-size:11px; padding:4px 8px; }
    .replies{ margin-left:36px; gap:8px; }
    #loadMore{ margin:8px var(--inner) 12px; }
    input[type="text"], textarea{ padding:10px 12px; }

    #pollBuilder{display:none;flex-direction:column;gap:10px;border:1px dashed #c9e5f8;background:#f7fbff;border-radius:14px;padding:14px;margin-top:-4px}
    #pollBuilder h3{margin:0;font-size:14px;color:#0f3c55}
    .poll-builder-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .poll-option-input{display:flex;gap:8px;align-items:center;width:100%}
    .poll-option-input input{flex:1}
    .poll-option-input button{min-width:40px;padding:8px 10px}
    .poll-option-input button.remove{background:#fdecea;border-color:#f5b7af;color:#d93025}

    @media (max-width:640px){
      .avatar{ width:28px; height:28px; flex-basis:28px; }
      .meta, .action{ font-size:10px; }
      .content img{ max-width:100%; }
    }
  </style>
</head>
<body>
  <main class="container">
    <!-- Admin Panel (JS will reveal only on /chatboard/?admin=1 or when logged in) -->
    <section id="adminPanel" class="panel">
      <div class="row">
        <strong>Admin</strong>
        <span id="adminNote" class="tag">Login to manage comments</span>
        <span id="conn" class="tag">Checking…</span>
      </div>
      <div class="row" id="adminLoginRow">
        <input id="adminPass" type="password" placeholder="Admin password"/>
        <button id="btnAdminLogin" class="btn">Login</button>
      </div>
      <div class="row" id="adminControls" style="display:none">
        <span class="tag">Pinned: <span id="pinCount">0</span> / 3</span>
        <span class="tag">Total: <span id="statTotal">0</span></span>
        <span class="tag">Replies: <span id="statReplies">0</span></span>
        <span class="tag">Today: <span id="statToday">0</span></span>
        <span class="tag">Online: <span id="onlineUsers">0</span> users / <span id="onlineTabs">0</span> tabs</span>
        <label class="tag" style="display:inline-flex;gap:6px;align-items:center">
          <input type="checkbox" id="toggleReplies">
          Replies enabled
        </label>
        <label class="tag" style="display:inline-flex;gap:6px;align-items:center">
          <input type="checkbox" id="togglePosts">
          Only admin can post
        </label>
        <button id="btnAdminLogout" class="btn">Logout</button>
      </div>
    </section>

    <section id="cleanupPanel" class="panel">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3>Keyword cleanup</h3>
        <span id="cleanupStatus">Enter a keyword to search.</span>
      </div>
      <div class="row cleanup-controls">
        <label class="field">
          Keyword
          <input id="cleanupKeyword" type="text" placeholder="Word or phrase" autocomplete="off"/>
        </label>
        <label class="field">
          Start (optional)
          <input id="cleanupStart" type="datetime-local"/>
        </label>
        <label class="field">
          End (optional)
          <input id="cleanupEnd" type="datetime-local"/>
        </label>
      </div>
      <div class="row cleanup-actions">
        <label class="tag" style="display:inline-flex;gap:6px;align-items:center">
          <input type="checkbox" id="cleanupSelectAll" checked>
          Select all
        </label>
        <button id="btnCleanupPreview" class="btn">Preview matches</button>
        <button id="btnCleanupDelete" class="btn danger">Delete selected</button>
      </div>
      <div id="cleanupResults" class="cleanup-results empty">No matches loaded.</div>
    </section>

    <!-- Composer -->
    <section id="composer" class="panel">
      <div class="row">
        <input id="nick" type="text" placeholder="Nickname (optional, default Anonymous)" maxlength="10"/>
      </div>

      <div id="replyTo" class="row">
        Replying to <strong id="replyName"></strong><span id="replyCancel" title="Cancel reply">✕</span>
      </div>

      <div class="row">
        <textarea id="text" placeholder="Type your message… You can also attach an image."></textarea>
      </div>

      <!-- Inline embed UI (admin only; JS toggles visibility) -->
      <div id="embedBox" class="row" style="display:none;flex-direction:column;align-items:stretch;gap:8px">
        <div class="row row-slim" style="gap:8px">
          <label class="tag" style="display:inline-flex;gap:6px;align-items:center">
            Mode
            <select id="embedMode">
              <option value="url">Website URL</option>
              <option value="html">Raw HTML</option>
            </select>
          </label>
        </div>
        <input id="embedUrl" type="text" placeholder="https://example.com (embedded in sandboxed iframe)"/>
        <textarea id="embedHtml" placeholder="&lt;div&gt;Custom HTML&lt;/div&gt;" style="display:none;min-height:120px"></textarea>
        <div class="row row-slim" style="gap:8px">
          <button id="btnEmbedInsert" class="btn">Insert embed</button>
          <span class="limits">Embeds are sandboxed (no referrer; allow-scripts + same-origin).</span>
        </div>
      </div>

      <div id="pollBuilder" class="row" style="display:none;flex-direction:column;align-items:stretch;gap:10px">
        <div class="poll-builder-row" style="justify-content:space-between">
          <h3>Create poll</h3>
          <span class="limits">2–8 options · 80 chars max</span>
        </div>
        <input id="pollQuestion" type="text" placeholder="Poll question" maxlength="200"/>
        <div id="pollOptionsWrap" style="display:flex;flex-direction:column;gap:8px"></div>
        <div class="poll-builder-row" style="justify-content:space-between">
          <button id="btnPollAddOption" class="btn">Add option</button>
          <div style="display:flex;gap:8px;margin-left:auto">
            <button id="btnPollCancel" class="btn">Cancel</button>
            <button id="btnPollSend" class="btn primary">Send poll</button>
          </div>
        </div>
      </div>

      <div class="row row-slim">
        <label for="file" class="btn file-btn" id="btnChoose">Choose image</label>
        <input id="file" type="file" accept="image/*"/>
        <span id="fileInfo" class="file-name"></span>
        <button id="btnAttach" class="btn">Attach image</button>
        <div style="margin-left:auto;display:flex;align-items:center;gap:8px">
          <!-- Admin-only: shown by JS when logged in and not replying -->
          <label id="optNoReply" class="tag" style="display:none;gap:6px;align-items:center;margin-right:0">
            <input type="checkbox" id="sendNoReply">
            No replies
          </label>
          <label id="optAutoPin" class="tag" style="display:none;gap:6px;align-items:center;margin-right:0">
            <input type="checkbox" id="sendAutoPin">
            Auto pin
          </label>
          <button id="btnCreatePoll" class="btn" style="display:none">Create poll</button>
          <button id="btnSend" class="btn primary">Send</button>
        </div>
      </div>

      <div class="row row-slim" style="margin-top:-2px">
        <span class="limits">
          Images: PNG/JPG/GIF/WebP ≤ <span id="limitMb">7</span> MB · Message limit: <span id="limitChars">2000</span> chars ·
          <span id="charCount">0</span>/<span id="limitChars2">2000</span>
        </span>
        <span id="status" style="margin-left:auto"></span>
      </div>
    </section>

    <section id="roomPanel" class="panel room-panel">
      <span class="label">Rooms</span>
      <div class="room-buttons">
        <button class="room-btn" data-room="chat">Chat</button>
        <button class="room-btn" data-room="tracks">Track Sharing</button>
      </div>
    </section>

    <section id="sortPanel" class="panel sort-panel">
      <span class="label">Sort</span>
      <div class="sort-buttons">
        <button class="sort-btn" data-sort="newest">Newest</button>
        <button class="sort-btn" data-sort="oldest">Oldest</button>
        <button class="sort-btn" data-sort="likes">Most Likes</button>
      </div>
    </section>

    <!-- Messages -->
    <section class="panel">
      <div id="messages"></div>
      <button id="loadMore" class="btn primary">Load older</button>
    </section>
  </main>

<script src="index.js?v=42"></script>
</body>
</html>
