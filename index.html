<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chatboard Comments</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica,Arial,sans-serif;margin:0;padding:24px;background:#0e0f12;color:#eaeaea}
    .wrap{max-width:860px;margin:0 auto}
    .bar{display:flex;gap:8px;align-items:center;margin:12px 0 18px}
    .bar button,.bar label{border:1px solid #2b2f3a;background:#1b1f2a;color:#eaeaea;padding:8px 12px;border-radius:10px;cursor:pointer}
    .bar button:hover,.bar label:hover{background:#232838}
    .bar small{opacity:.7}
    .hidden{display:none}
    .notice{font-size:.9em;opacity:.75}
    a{color:#9bd}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/twikoo@1.6.40/dist/twikoo.all.min.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>Chatboard Comments</h1>

    <div class="bar">
      <label for="imgInput">ðŸ“· Upload image</label>
      <input id="imgInput" class="hidden" type="file" accept="image/*" />
      <button id="pasteHelp" type="button">How to paste</button>
      <small class="notice" id="status">Ready.</small>
    </div>

    <div id="tcomment"></div>
    <p class="notice">Images upload via <a href="https://api.imgbb.com/" target="_blank" rel="noopener">imgbb</a>.</p>
  </div>

  <script>
    // === SETTINGS ===
    const WORKER_URL = 'https://twikoo-cloudflare.ertertertet07.workers.dev'; // your Worker
    const IMGBB_KEY  = 'a067e2d782732e418117eb31cfa6fe8c';
    // Group per path on GitHub Pages repo (e.g. /chatboard/, /chatboard/subpage)
    const PATH = location.pathname; // works for https://htmlunblockedgames.github.io/chatboard/
    // =================

    // Init Twikoo
    twikoo.init({
      el: '#tcomment',
      envId: WORKER_URL,
      lang: 'en',
      path: PATH
    });

    // Helpers
    const $status = document.getElementById('status');
    function setStatus(m){ $status.textContent = m; }
    function tkTextarea(){ return document.querySelector('#tcomment textarea.el-textarea__inner'); }
    function insertAtCursor(ta, text){
      if(!ta) return;
      const s = ta.selectionStart ?? ta.value.length;
      const e = ta.selectionEnd ?? ta.value.length;
      ta.value = ta.value.slice(0,s) + text + ta.value.slice(e);
      const pos = s + text.length;
      ta.setSelectionRange(pos,pos); ta.focus();
    }

    async function uploadToImgbb(file){
      setStatus('Uploading imageâ€¦');
      const dataUrl = await new Promise((res,rej)=>{
        const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=()=>rej(fr.error||new Error('read failed')); fr.readAsDataURL(file);
      });
      const pure = dataUrl.split(',')[1];
      const form = new FormData();
      form.append('image', pure);
      form.append('name', (file.name||'upload').replace(/\.[^.]+$/,''));
      const resp = await fetch('https://api.imgbb.com/1/upload?key='+encodeURIComponent(IMGBB_KEY), { method:'POST', body:form });
      if(!resp.ok) throw new Error('imgbb HTTP '+resp.status);
      const json = await resp.json();
      const url = json?.data?.url;
      if(!url) throw new Error('imgbb response missing URL');
      setStatus('Upload done.');
      return url;
    }

    function insertImageMarkdown(url){
      const ta = tkTextarea();
      const md = `![image](${url})`;
      insertAtCursor(ta, (ta && ta.value && !ta.value.endsWith('\n') ? '\n' : '') + md + '\n');
      setStatus('Image inserted.');
    }

    document.getElementById('imgInput').addEventListener('change', async (e)=>{
      const file = e.target.files?.[0]; if(!file) return;
      try { insertImageMarkdown(await uploadToImgbb(file)); }
      catch(err){ console.error(err); setStatus('Image Upload failed: '+(err.message||'unknown')); alert('Image Upload failed: '+(err.message||'unknown')); }
      finally { e.target.value=''; }
    });

    document.getElementById('pasteHelp').addEventListener('click', ()=>{
      alert('Tip: Focus the comment box, then paste (Ctrl/Cmd+V) an image to upload automatically.');
    });

    document.addEventListener('paste', async (evt)=>{
      const ta = tkTextarea();
      if (!ta || document.activeElement !== ta) return;
      const items = evt.clipboardData?.items; if(!items) return;
      for (const it of items){
        if (it.type?.startsWith('image/')){
          const file = it.getAsFile(); if(!file) continue;
          evt.preventDefault();
          try { insertImageMarkdown(await uploadToImgbb(file)); }
          catch(err){ console.error(err); setStatus('Image Upload failed: '+(err.message||'unknown')); alert('Image Upload failed: '+(err.message||'unknown')); }
          break;
        }
      }
    });

    // Server-side: ensure your Worker allows this origin in CORS:
    // CORS_ALLOW_ORIGIN = "https://htmlunblockedgames.github.io"
    // (you can include multiple origins separated by commas)
  </script>
</body>
</html>
